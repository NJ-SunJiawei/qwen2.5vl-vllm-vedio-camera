<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Video Analysis</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css?v=1.0" rel="stylesheet">
</head>
<body class="p-6">
    <h1 class="text-2xl font-bold mb-4">目标检测</h1>
    
    <!-- 上传表单 -->
    <form id="uploadForm">
        <input type="file" id="videoInput" accept="video/*" class="border p-2 rounded">
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">上传视频</button>
    </form>

    <!-- 分析按钮 -->
    <div id="analyzeSection" class="mt-4 hidden">
        <input type="text" id="objectInput" placeholder="输入要检测的对象" class="border p-2 rounded">
        <button id="analyzeButton" class="bg-green-500 text-white px-4 py-2 rounded">开始分析</button>
    </div>

    <!-- 视频播放器和画布 -->
    <div class="mt-6 relative">
        <canvas id="videoCanvas" class="w-full max-w-2xl"></canvas>
        <canvas id="overlayCanvas" class="absolute top-0 left-0 pointer-events-none"></canvas>
    </div>

    <script>
        // WebSocket 连接
        let ws = new WebSocket(`ws://${window.location.host}/ws`);

        // 获取 DOM 元素
        const videoCanvas = document.getElementById('videoCanvas');
        const overlayCanvas = document.getElementById('overlayCanvas');
        const videoCtx = videoCanvas.getContext('2d');
        const overlayCtx = overlayCanvas.getContext('2d');

        let lastFrameTime = 0;
        const frameInterval = 1000 / 10;  // 目标帧率：10 FPS

        // WebSocket 连接事件
        ws.onopen = () => {
            console.log("WebSocket connected");
        };

        // WebSocket 消息事件
        ws.onmessage = (event) => {
            const currentTime = performance.now();
            if (currentTime - lastFrameTime >= frameInterval) {
                lastFrameTime = currentTime;

                console.log("Received WebSocket message:", event.data);  // 调试日志
                const data = JSON.parse(event.data);
                const frame = data.frame;  // 获取 base64 帧
                const bbox = data.bbox;  // 获取 bbox
                const label = data.label;  // 获取 label

                // 将 base64 帧绘制到 videoCanvas 上
                const img = new Image();
                img.src = `data:image/jpeg;base64,${frame}`;
                img.onload = () => {
                    videoCanvas.width = img.width;
                    videoCanvas.height = img.height;
                    overlayCanvas.width = img.width;
                    overlayCanvas.height = img.height;
                    videoCtx.drawImage(img, 0, 0, img.width, img.height);

                    // 绘制绿框和 label（如果有）
                    if (bbox && bbox.length === 4) {
                        drawBoundingBoxes({
                            bbox: bbox,
                            label: label
                        });
                    } else {
                        overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);  // 清空画布
                    }
                };
            }
        };

        // WebSocket 错误事件
        ws.onerror = (error) => {
            console.error("WebSocket error:", error);
        };

        // WebSocket 关闭事件
        ws.onclose = () => {
            console.log("WebSocket disconnected");
            // 尝试重连
            setTimeout(() => {
                ws = new WebSocket(`ws://${window.location.host}/ws`);
            }, 1000);
        };

        // 绘制绿框和 label
        function drawBoundingBoxes(data) {
            overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);  // 每次绘制前清空画布

            if (data.bbox && data.bbox.length === 4) {  // 如果有 bbox 数据
                const [x1, y1, x2, y2] = data.bbox;  // 解析 bbox 坐标
                const label = data.label;  // 获取 label

                // 绘制绿框
                overlayCtx.strokeStyle = "green";
                overlayCtx.lineWidth = 2;
                overlayCtx.strokeRect(x1, y1, x2 - x1, y2 - y1);

                // 绘制 label
                overlayCtx.font = "14px Arial";
                overlayCtx.fillStyle = "green";
                overlayCtx.fillText(label, x1, y1 - 5);  // 在框的上方显示 label
            }
        }

        // 表单提交事件（上传视频）
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log("Form submitted");  // 调试日志

            const formData = new FormData();
            formData.append('video', document.getElementById('videoInput').files[0]);

            try {
                const response = await fetch('/upload', { method: 'POST', body: formData });
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                const result = await response.json();
                console.log("Video uploaded successfully");  // 调试日志
                // 显示分析部分
                document.getElementById('analyzeSection').classList.remove('hidden');
                // 保存文件名
                document.getElementById('analyzeButton').dataset.filename = result.filename;
            } catch (error) {
                console.error("Error during video upload:", error);
            }
        });

        // 分析按钮点击事件
        document.getElementById('analyzeButton').addEventListener('click', async () => {
            const objectStr = document.getElementById('objectInput').value;
            if (!objectStr) {
                alert("请输入要检测的对象");
                return;
            }

            const filename = document.getElementById('analyzeButton').dataset.filename;
            if (!filename) {
                alert("请先上传视频");
                return;
            }

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ object_str: objectStr, filename: filename })
                });
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                console.log("Analysis started");  // 调试日志
            } catch (error) {
                console.error("Error during analysis:", error);
            }
        });
    </script>
</body>
</html>