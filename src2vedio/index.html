<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Video Analysis</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css?v=1.0" rel="stylesheet">
</head>
<body class="p-6">
    <h1 class="text-2xl font-bold mb-4">目标检测</h1>
    
    <!-- 上传表单 -->
    <form id="uploadForm">
        <input type="file" id="videoInput" accept="video/*" class="border p-2 rounded">
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">上传视频</button>
    </form>

    <!-- 分析按钮 -->
    <div id="analyzeSection" class="mt-4 hidden">
        <input type="text" id="objectInput" placeholder="输入要检测的对象" class="border p-2 rounded">
        <button id="analyzeButton" class="bg-green-500 text-white px-4 py-2 rounded">开始分析</button>
    </div>

    <!-- 视频播放器和画布 -->
    <div class="mt-6 relative">
        <canvas id="videoCanvas" class="w-full max-w-2xl"></canvas>
        <canvas id="overlayCanvas" class="absolute top-0 left-0 pointer-events-none"></canvas>
    </div>

    <script>
        // 建立 WebSocket 连接
        let ws = new WebSocket(`ws://${window.location.host}/ws`);

        // 获取 DOM 元素
        const videoCanvas = document.getElementById('videoCanvas');
        const overlayCanvas = document.getElementById('overlayCanvas');
        const videoCtx = videoCanvas.getContext('2d');
        const overlayCtx = overlayCanvas.getContext('2d');

        // WebSocket 消息事件处理
        ws.onmessage = async (event) => {
            // 如果消息是二进制，则作为视频帧处理
            if (event.data instanceof Blob) {
                const blob = event.data;
                const url = URL.createObjectURL(blob);
                const img = new Image();
                img.src = url;
                img.onload = () => {
                    videoCanvas.width = img.width;
                    videoCanvas.height = img.height;
                    overlayCanvas.width = img.width;
                    overlayCanvas.height = img.height;
                    videoCtx.drawImage(img, 0, 0, img.width, img.height);
                };
            } else {
                // 如果消息是文本，则解析为 JSON 并绘制绿框
                let jsonStr;
                if (typeof event.data === "string") {
                    jsonStr = event.data;
                } else if (event.data.text) {
                    jsonStr = await event.data.text();
                }
                try {
                    const data = JSON.parse(jsonStr);
                    console.log("Received result:", data);
                    drawBoundingBoxes(data);
                } catch (error) {
                    console.error("Failed to parse JSON:", error);
                }
            }
        };

        // 绘制边界框和 label 的函数
        function drawBoundingBoxes(data) {
            overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            if (data.bbox && data.bbox.length === 4) {
                const [x1, y1, x2, y2] = data.bbox;
                const label = data.label;
                overlayCtx.strokeStyle = "green";
                overlayCtx.lineWidth = 2;
                overlayCtx.strokeRect(x1, y1, x2 - x1, y2 - y1);
                overlayCtx.font = "14px Arial";
                overlayCtx.fillStyle = "green";
                overlayCtx.fillText(label, x1, y1 - 5);
            }
        }

        // 表单提交事件（上传视频）
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log("Form submitted");
            const formData = new FormData();
            formData.append('video', document.getElementById('videoInput').files[0]);
            try {
                const response = await fetch('/upload', { method: 'POST', body: formData });
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                const result = await response.json();
                console.log("Video uploaded successfully");
                document.getElementById('analyzeSection').classList.remove('hidden');
                document.getElementById('analyzeButton').dataset.filename = result.filename;
            } catch (error) {
                console.error("Error during video upload:", error);
            }
        });

        // 分析按钮点击事件
        document.getElementById('analyzeButton').addEventListener('click', async () => {
            const objectStr = document.getElementById('objectInput').value;
            if (!objectStr) {
                alert("请输入要检测的对象");
                return;
            }
            const filename = document.getElementById('analyzeButton').dataset.filename;
            if (!filename) {
                alert("请先上传视频");
                return;
            }
            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ object_str: objectStr, filename: filename })
                });
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                console.log("Analysis started");
            } catch (error) {
                console.error("Error during analysis:", error);
            }
        });
    </script>
</body>
</html>
